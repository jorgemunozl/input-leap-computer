#!/bin/bash
set -euo pipefail

# Leap - Simple wrapper for Input Leap Manager
# Usage: leap [command]

# Colors for error messages
readonly RED='\033[0;31m'
readonly YELLOW='\033[1;33m'
readonly CYAN='\033[0;36m'
readonly NC='\033[0m'

# Find the project root (assuming this script is in bin/)
# Use readlink to resolve symlinks and get the actual script location
readonly SCRIPT_PATH="$(readlink -f "${BASH_SOURCE[0]}")"
readonly SCRIPT_DIR="$(dirname "$SCRIPT_PATH")"
readonly PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"
readonly MANAGER="$SCRIPT_DIR/input-leap-manager"
readonly NETWORK_MANAGER="$SCRIPT_DIR/network-manager"

# Check if required scripts exist
check_installation() {
    local missing=()
    
    if [[ ! -x "$MANAGER" ]]; then
        missing+=("input-leap-manager")
    fi
    
    if [[ ! -x "$NETWORK_MANAGER" ]]; then
        missing+=("network-manager")
    fi
    
    if [[ ${#missing[@]} -gt 0 ]]; then
        echo -e "${RED}‚ùå Error: Missing required scripts: ${missing[*]}${NC}" >&2
        echo -e "${YELLOW}üí° This usually means:${NC}" >&2
        echo -e "   ${CYAN}‚Ä¢ You're not in the input-leap directory${NC}" >&2
        echo -e "   ${CYAN}‚Ä¢ The setup script wasn't run properly${NC}" >&2
        echo -e "   ${CYAN}‚Ä¢ Files got moved or deleted${NC}" >&2
        echo "" >&2
        echo -e "${YELLOW}üîß To fix this:${NC}" >&2
        echo -e "   ${CYAN}cd input-leap${NC}" >&2
        echo -e "   ${CYAN}./setup.sh${NC}" >&2
        return 1
    fi
    
    return 0
}

# Check installation before proceeding
if ! check_installation; then
    exit 1
fi

# Handle network-specific commands
case "${1:-}" in
    "network")
        shift
        exec "$NETWORK_MANAGER" "$@"
        ;;
    "net")
        shift
        exec "$NETWORK_MANAGER" "$@"
        ;;
    "ethernet")
        echo -e "${CYAN}üîß Input Leap Ethernet Setup${NC}"
        echo "This will configure your ethernet with standard Input Leap IPs:"
        echo ""
        echo -e "${YELLOW}Choose your role:${NC}"
        echo -e "  ${CYAN}1) Server (169.254.135.230)${NC} - The main computer"
        echo -e "  ${CYAN}2) Client (169.254.135.231)${NC} - The laptop/secondary computer"
        echo ""
        read -p "Enter your choice [1-2]: " role_choice
        
        case "$role_choice" in
            1)
                echo -e "${CYAN}Setting up as SERVER (169.254.135.230)...${NC}"
                exec "$NETWORK_MANAGER" static_ip "169.254.135.230"
                ;;
            2)
                echo -e "${CYAN}Setting up as CLIENT (169.254.135.231)...${NC}"
                exec "$NETWORK_MANAGER" static_ip "169.254.135.231"
                ;;
            *)
                echo -e "${RED}‚ùå Invalid choice. Please choose 1 or 2.${NC}"
                exit 1
                ;;
        esac
        ;;
    *)
        # Execute the manager with all arguments
        exec "$MANAGER" "$@"
        ;;
esac
